<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Documentação</title>
  <!-- CSS global que controla layout -->
  <link rel="stylesheet" href="/styles/global.css">
  <!-- Tema (anti-flicker): aplica o tema salvo antes do primeiro paint -->
  <script>
    (function(){
      try {
        var saved = localStorage.getItem('rhyla-theme') || 'light';
        var link = document.createElement('link');
        link.id = 'theme-style';
        link.rel = 'stylesheet';
        link.href = '/styles/' + (saved === 'dark' ? 'dark' : 'light') + '.css';
        document.write(link.outerHTML);
      } catch (e) {
        document.write('<link id="theme-style" rel="stylesheet" href="/styles/light.css">');
      }
    })();
  </script>
</head>
<body>
  <header class="rhyla-header">
    <div class="rhyla-brand">
      <img id="rhyla-logo" src="/public/logo.png" alt="Logo da Documentação" style="height:100px;width:auto;">
    </div>
    <div class="rhyla-actions">
      <button id="theme-toggle" class="theme-switch" aria-label="Alternar tema">🌙 Dark</button>
    </div>
  </header>
  
<script>
  (function(){
    const themeToggle = document.getElementById('theme-toggle');
    const themeLink = document.getElementById('theme-style');

    function setTheme(theme) {
      themeLink.href = '/styles/' + theme + '.css';
      localStorage.setItem('rhyla-theme', theme);
      themeToggle.textContent = theme === 'light' ? '🌙 Dark' : '☀️ Light';
    }

    const saved = localStorage.getItem('rhyla-theme') || 'light';
    setTheme(saved);

    themeToggle.addEventListener('click', () => {
      const cur = localStorage.getItem('rhyla-theme') || 'light';
      setTheme(cur === 'light' ? 'dark' : 'light');
    });

    fetch('/config.json')
      .then(r => r.ok ? r.json() : null)
      .then(cfg => {
        if (cfg && cfg.title) {
          const t = document.getElementById('rhyla-title');
          if (t) t.textContent = cfg.title;
        }
      });

    // Navegação SPA leve: intercepta links internos e troca apenas o <main>
    function isInternalNavigable(a){
      if (!a || a.target === '_blank') return false;
      const url = new URL(a.href, location.origin);
      if (url.origin !== location.origin) return false;
      const p = url.pathname;
      const excludes = [/\.(css|js|json|png|jpe?g|svg|gif|webp|ico|pdf|zip)(\?|#|$)/i, /^\/public\//, /^\/styles\//];
      if (excludes.some(rx => rx.test(p))) return false;
      return true;
    }

    function executeScripts(container){
      const nodes = Array.from(container.querySelectorAll('script'));
      for (const old of nodes){
        const s = document.createElement('script');
        if (old.src) {
          // Recarrega scripts externos
          s.src = old.src;
        } else {
          // Evita redeclaração de let/const no escopo global
          const code = String(old.textContent || '');
          s.textContent = `(function(){\n${code}\n})();`;
        }
        if (old.type) s.type = old.type;
        old.replaceWith(s);
      }
    }

    function updateActiveSidebar(pathname){
      try {
        const sb = document.querySelector('.rhyla-sidebar');
        if (!sb) return;
        sb.querySelectorAll('li.active').forEach(li => li.classList.remove('active'));
        const link = sb.querySelector(`a[href='${pathname}'], a[href='${pathname}.html']`);
        if (link){
          const li = link.closest('li');
          if (li) li.classList.add('active');
          const group = link.closest('.group');
          if (group){
            group.classList.add('open');
            const content = group.querySelector('.group-content');
            if (content) content.style.maxHeight = content.scrollHeight + 'px';
            const arrow = group.querySelector('.dropdown-arrow');
            if (arrow) arrow.classList.add('open');
          }
        }
      } catch(_){}
    }

    function swapMainFromHTML(html, newUrl, doPush){
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const newMain = doc.querySelector('main.rhyla-main');
      const main = document.querySelector('main.rhyla-main');
      if (!newMain || !main) return false;
      main.innerHTML = newMain.innerHTML;
      executeScripts(main);
      if (newUrl && doPush) history.pushState({}, '', newUrl);
      updateActiveSidebar(newUrl || location.pathname);
      main.scrollTop = 0;
      return true;
    }

    async function navigate(href, doPush = true){
      try{
        const res = await fetch(href, { credentials: 'same-origin' });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const html = await res.text();
        if (!swapMainFromHTML(html, href, doPush)) location.assign(href);
      } catch(err){ location.assign(href); }
    }

    document.addEventListener('click', (e) => {
      if (e.defaultPrevented) return;
      if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || e.button !== 0) return;
      const a = e.target.closest('a');
  if (!a) return;
  const rawHref = a.getAttribute('href') || '';
  if (rawHref.startsWith('#')) return; // permitir âncoras
      if (!isInternalNavigable(a)) return;
      e.preventDefault();
  navigate(rawHref, true);
    });

    window.addEventListener('popstate', () => {
  navigate(location.pathname + location.search + location.hash, false);
    });
  })();
</script>
