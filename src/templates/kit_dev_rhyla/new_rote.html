<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Routes - Rhyla</title>
    <link rel="stylesheet" href="/styles/page-generator.css">
</head>

<body class="page-generator-component">
    <div class="page-generator">
    <h1>API Page Generator</h1>
    <p>Use this form to generate RESTful API documentation automatically.</p>

        <div class="pg-panel">
            <h3>Route Information</h3>

            <div class="pg-form-group">
                <label for="route-title">Route Title</label>
                <input type="text" id="route-title" class="pg-form-control" placeholder="Example: Create User">
            </div>

            <div class="pg-form-group">
                <label for="route-path">Route Path</label>
                <input type="text" id="route-path" class="pg-form-control" placeholder="Example: /api/users">
            </div>
            <div class="pg-form-group">
                <small class="pg-note">Note: the <strong>Route Path</strong> field will be used to create the file inside <code>rhyla-docs/body</code> — the last segment becomes the file name (spaces will be converted to <code>_</code>). Missing folders will be created automatically. Do not include extensions such as <code>.md</code> or <code>.html</code> in this field.</small>
            </div>

            <div class="pg-form-group">
                <label>Método HTTP</label>
                <div class="pg-method-select">
                    <button class="pg-method-btn pg-get active" data-method="GET">GET</button>
                    <button class="pg-method-btn pg-post" data-method="POST">POST</button>
                    <button class="pg-method-btn pg-put" data-method="PUT">PUT</button>
                    <button class="pg-method-btn pg-delete" data-method="DELETE">DELETE</button>
                    <button class="pg-method-btn pg-patch" data-method="PATCH">PATCH</button>
                </div>
            </div>

            <div class="pg-form-group pg-tag-section">
                <label>Tags</label>
                <div class="pg-tags">
                    <label class="pg-tag-option">
                        <input type="radio" name="tags" value="new"> Novo
                    </label>
                    <label class="pg-tag-option">
                        <input type="radio" name="tags" value="dep"> Obsoleto
                    </label>
                    <label class="pg-tag-option">
                        <input type="radio" name="tags" value="v1"> v1
                    </label>
                    <label class="pg-tag-option">
                        <input type="radio" name="tags" value="v2"> v2
                    </label>
                    <label class="pg-tag-option">
                        <input type="radio" name="tags" value="v3"> v3
                    </label>
                </div>
            </div>

            <div class="pg-form-group">
                <label for="route-description">Descrição</label>
                <textarea id="route-description" class="pg-form-control"
                    placeholder="Descreva o propósito desta rota..."></textarea>
            </div>
        </div>

        <div class="pg-panel">
            <h3>Request Parameters</h3>

            <div class="pg-row">
                <div class="pg-col">
                    <div class="pg-form-group">
                        <label for="request-body">Request Body (JSON)</label>
                        <textarea id="request-body" class="pg-form-control" 
                            placeholder='{"name": "string", "email": "string"}'></textarea>
                    </div>
                </div>
                <div class="pg-col">
                    <div class="pg-form-group">
                        <label for="request-headers">Headers</label>
                        <textarea id="request-headers" class="pg-form-control"
                            placeholder="Content-Type: application/json&#10;Authorization: Bearer {token}"></textarea>
                    </div>
                </div>
            </div>

            <div class="pg-form-group">
                <label for="query-params">URL Parameters</label>
                <textarea id="query-params" class="pg-form-control"
                    placeholder="page: page number (optional)&#10;limit: items per page (optional)"></textarea>
            </div>
        </div>

        <div class="pg-panel">
            <h3>Responses</h3>

            <div class="pg-form-group">
                <label for="response-success">Success Response (200)</label>
                <textarea id="response-success" class="pg-form-control" 
                    placeholder='{"id": 1, "name": "John Doe", "email": "john@example.com", "createdAt": "2025-08-23T10:00:00Z"}'></textarea>
            </div>

            <div class="pg-form-group">
                <label for="response-error">Error Responses</label>
                <textarea id="response-error" class="pg-form-control" 
                    placeholder="400 Bad Request:&#10;{&#10;  \"error\": \"Validation error\",&#10;  \"message\": \"Email is required\"&#10;}&#10;&#10;404 Not Found:&#10;{&#10;  \"error\": \"Not found\",&#10;  \"message\": \"User not found\"&#10;}"></textarea>
            </div>
        </div>

        <div class="pg-panel">
            <h3>cURL Example</h3>
            <div class="pg-form-group">
                <label for="curl-command">cURL Command</label>
                <textarea id="curl-command" class="pg-form-control"
                    placeholder="curl -X POST \\\n  https://api.example.com/api/users \\\n  -H 'Content-Type: application/json' \\\n  -H 'Authorization: Bearer YOUR_TOKEN' \\\n  -d '{\"name\": \"John Doe\", \"email\": \"john@example.com\"}'"></textarea>
            </div>
        </div>

        <div class="pg-form-group">
            <h3>Preview</h3>
            <div class="pg-preview">
                # Create User

                <span class="http-method pg-post">POST</span> <span class="post-tag post-tag--new">new</span> <span
                    class="post-tag post-tag--v1">v1</span>

                `/api/users`

                Creates a new user in the system.

                ## Request

                ### Headers
                ```
                Content-Type: application/json
                Authorization: Bearer {token}
                ```

                ### Body
                ```json
                {
                "name": "John Doe",
                "email": "john@example.com"
                }
                ```

                ## Response

                ### 200 OK
                ```json
                {
                "id": 1,
                "name": "John Doe",
                "email": "john@example.com",
                "createdAt": "2025-08-23T10:00:00Z"
                }
                ```

                ### Errors
                ```
                400 Bad Request:
                {
                "error": "Validation error",
                "message": "Email is required"
                }

                404 Not Found:
                {
                "error": "Not found",
                "message": "User not found"
                }
                ```

                ## cURL Example
                ```bash
                curl -X POST \
                https://api.example.com/api/users \
                -H 'Content-Type: application/json' \
                -H 'Authorization: Bearer YOUR_TOKEN' \
                -d '{
                "name": "John Doe",
                "email": "john@example.com"
                }'
                ```
            </div>
        </div>

        <div class="pg-form-group">
    <button id="generate-btn" class="pg-btn-primary">Generate Page</button>
    </div>
    </div>

    <script type="module">
        // Importar funções do gerador de páginas
        import { buildFilePath, generateMDFile } from '/scripts/generatePages.js';
        
        // Elementos do formulário
        const routeTitle = document.getElementById('route-title');
        const routePath = document.getElementById('route-path');
        const routeDescription = document.getElementById('route-description');
        const requestBody = document.getElementById('request-body');
        const requestHeaders = document.getElementById('request-headers');
        const queryParams = document.getElementById('query-params');
        const responseSuccess = document.getElementById('response-success');
        const responseError = document.getElementById('response-error');
        const curlCommand = document.getElementById('curl-command');
        const previewElement = document.querySelector('.pg-preview');

    // Variable to store the selected HTTP method
        let selectedMethod = 'GET';

    // Code to select HTTP method
        document.querySelectorAll('.pg-method-btn').forEach(button => {
            button.addEventListener('click', function () {
                // Remove classe active de todos os botões
                document.querySelectorAll('.pg-method-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Adiciona classe active ao botão clicado
                this.classList.add('active');

                // Atualiza o método selecionado
                selectedMethod = this.dataset.method;

                // Gera o cURL e atualiza a pré-visualização
                generateCurl();
                updatePreview();
            });
        });

    // Function to generate the cURL command from the form fields
        function generateCurl() {
            // Verifica se o caminho da rota está preenchido
            if (!routePath.value) {
                return;
            }

            // Inicia o comando cURL com o método e caminho
            let curl = `curl -X ${selectedMethod} \\\n  https://api.example.com${routePath.value}`;

            // Adiciona headers se houver
            const headerLines = requestHeaders.value.trim().split('\n');
            if (headerLines[0] !== '') {
                headerLines.forEach(header => {
                    if (header.trim()) {
                        const [key, value] = header.split(':').map(part => part.trim());
                        curl += ` \\\n  -H '${key}: ${value}'`;
                    }
                });
            }

            // Adiciona parâmetros de query se houver
            const queryParamsLines = queryParams.value.trim().split('\n');
            if (queryParamsLines[0] !== '' && (selectedMethod === 'GET' || selectedMethod === 'DELETE')) {
                let queryString = '?';
                queryParamsLines.forEach((param, index) => {
                    if (param.trim()) {
                        const [key] = param.split(':').map(part => part.trim());
                        queryString += `${key}=value`;
                        if (index < queryParamsLines.length - 1 && queryParamsLines[index + 1].trim()) {
                            queryString += '&';
                        }
                    }
                });

                if (queryString !== '?') {
                    curl = curl.replace(routePath.value, `${routePath.value}${queryString}`);
                }
            }

            // Adiciona corpo da requisição se houver e se for um método adequado
            if (requestBody.value.trim() && ['POST', 'PUT', 'PATCH'].includes(selectedMethod)) {
                curl += ` \\\n  -d '${requestBody.value.trim().replace(/\n/g, '\n  ')}'`;
            }

            // Atualiza o campo de comando cURL
            curlCommand.value = curl;
        }

    // Function to update the preview
        function updatePreview() {
            // Get selected tags
            const selectedTags = [];
            document.querySelectorAll('input[name="tags"]:checked').forEach(tag => {
                selectedTags.push(tag.value);
            });

            // Cria as tags HTML
            const tagsHtml = selectedTags.map(tag => {
                if (tag === 'new') return '<span class="post-tag post-tag--new">new</span>';
                if (tag === 'dep') return '<span class="post-tag post-tag--dep">dep</span>';
                // version tags start with 'v'
                if (tag.startsWith('v')) return `<span class="post-tag post-tag--v">${tag}</span>`;
                return `<span class="post-tag">${tag}</span>`;
            }).join(' ');

            // Build the preview
            let preview = '';

            // Title
            preview += `# ${routeTitle.value || 'Título da Rota'}\n\n`;

            // HTTP method and tags
            preview += `<span class="http-method pg-${selectedMethod.toLowerCase()}">${selectedMethod}</span> ${tagsHtml}\n\n`;

            // Path
            preview += `\`${routePath.value || '/api/endpoint'}\`\n\n`;

            // Description
            preview += `${routeDescription.value || 'Descrição da rota...'}\n\n`;

            // Request
            preview += `## Request\n\n`;

            // Headers
            if (requestHeaders.value.trim()) {
                preview += `### Headers\n\`\`\`\n${requestHeaders.value}\n\`\`\`\n\n`;
            }

            // Query Params
            if (queryParams.value.trim()) {
                preview += `### Query Parameters\n\`\`\`\n${queryParams.value}\n\`\`\`\n\n`;
            }

            // Body
            if (requestBody.value.trim()) {
                preview += `### Body\n\`\`\`json\n${requestBody.value}\n\`\`\`\n\n`;
            }

            // Response
            preview += `## Response\n\n`;

            // Success
            if (responseSuccess.value.trim()) {
                preview += `### 200 OK\n\`\`\`json\n${responseSuccess.value}\n\`\`\`\n\n`;
            }

            // Errors
            if (responseError.value.trim()) {
                preview += `### Erros\n\`\`\`\n${responseError.value}\n\`\`\`\n\n`;
            }

            // cURL
            preview += `## Exemplo cURL\n\`\`\`bash\n${curlCommand.value}\n\`\`\``;

            // Atualiza o elemento de pré-visualização
            previewElement.innerHTML = preview;
        }

    // Add event listeners for all form fields
        const formFields = [
            routeTitle, routePath, routeDescription, requestBody,
            requestHeaders, queryParams, responseSuccess, responseError
        ];

        formFields.forEach(field => {
            field.addEventListener('input', function () {
                generateCurl();
                updatePreview();
            });
        });

        // Event listeners for the tag inputs
        document.querySelectorAll('input[name="tags"]').forEach(input => {
            input.addEventListener('change', updatePreview);
        });

        // Permite editar diretamente o comando cURL
        curlCommand.addEventListener('input', updatePreview);

        // Função para obter o conteúdo do preview como markdown formatado
        function getPreviewContent() {
            // Vamos construir o conteúdo markdown manualmente a partir dos campos do formulário
            let mdContent = '';
            
            // Título
            mdContent += `# ${routeTitle.value || 'Título da Rota'}\n\n`;
            
            // Método HTTP (mantemos a tag HTML para estilização)
            mdContent += `<span class="http-method pg-${selectedMethod.toLowerCase()}">${selectedMethod}</span> `;
            
            // Tags (keep HTML spans for styling)
            const selectedTags = [];
            document.querySelectorAll('input[name="tags"]:checked').forEach(tag => {
                const value = tag.value;
                let tagClass = value;
                
                // Ajustar classe para versões
                if (value.startsWith('v')) {
                    tagClass = 'v';
                } else if (value === 'dep') {
                    tagClass = 'dep';
                }
                
                selectedTags.push(`<span class="post-tag post-tag--${tagClass}">${value}</span>`);
            });
            
            if (selectedTags.length > 0) {
                mdContent += selectedTags.join(' ') + '\n\n';
            } else {
                mdContent += '\n\n';
            }
            
            // Caminho
            mdContent += `\`${routePath.value || '/api/endpoint'}\`\n\n`;
            
            // Descrição
            mdContent += `${routeDescription.value || 'Descrição da rota...'}\n\n`;
            
            // Request
            mdContent += `## Request\n\n`;
            
            // Headers
            if (requestHeaders.value.trim()) {
                mdContent += `### Headers\n\`\`\`\n${requestHeaders.value}\n\`\`\`\n\n`;
            }
            
            // Query Params
            if (queryParams.value.trim()) {
                mdContent += `### Query Parameters\n\`\`\`\n${queryParams.value}\n\`\`\`\n\n`;
            }
            
            // Body
            if (requestBody.value.trim()) {
                mdContent += `### Body\n\`\`\`json\n${requestBody.value}\n\`\`\`\n\n`;
            }
            
            // Response
            mdContent += `## Response\n\n`;
            
            // Success
            if (responseSuccess.value.trim()) {
                mdContent += `### 200 OK\n\`\`\`json\n${responseSuccess.value}\n\`\`\`\n\n`;
            }
            
            // Errors
            if (responseError.value.trim()) {
                mdContent += `### Erros\n\`\`\`\n${responseError.value}\n\`\`\`\n\n`;
            }
            
            // cURL
            mdContent += `## Exemplo cURL\n\`\`\`bash\n${curlCommand.value}\n\`\`\``;
            
            return mdContent;
        }

        // Functionality to generate the page
        document.getElementById('generate-btn').addEventListener('click', function () {
            // Validate required fields
            if (!routePath.value) {
                alert('Please fill the route path before generating the file.');
                routePath.focus();
                return;
            }

            // Get selected tag (only one allowed)
            const selectedTags = [];
            document.querySelectorAll('input[name="tags"]:checked').forEach(tag => {
                selectedTags.push(tag.value);
            });

            // Build path using the imported function
            const filePath = buildFilePath(routePath.value, selectedMethod, selectedTags);
            const content = getPreviewContent();

            // Visual feedback
            const btn = this;
            btn.disabled = true;
            btn.innerText = 'Generating...';

            generateMDFile(filePath, content)
                .then(result => {
                    const relPath = result.path;
                    const fileUrl = window.location.origin + relPath.replace(/\.md$/, '.html');

                    const message = `\nFile generated successfully!\n\nPath: ${result.path}\nMethod: ${selectedMethod}\nFile name: ${filePath.split('/').pop()}\n\nYou can access the page at:\n${fileUrl}`;

                    alert(message);
                    console.log('File generated:', result);
                })
                .catch(error => {
                    alert(`Error generating file: ${error.message}`);
                    console.error('Error:', error);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerText = 'Generate Page';
                });
        });

        // Inicializa a pré-visualização
        generateCurl();
        updatePreview();
    </script>
</body>

</html>